<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Messagerie â€” Izrussia</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body {
  font-family:'Poppins',sans-serif;
  margin:0;
  padding:0;
  background:#f5f7fb;
  display:flex;
  flex-direction:column;
  min-height:100vh;
}
header {
  background:#0b0e0f;
  color:white;
  padding:15px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
header h2 {
  margin:0;
  font-size:18px;
}
.chat-box, .inbox-container {
  flex:1;
  overflow-y:auto;
  padding:15px;
}
.message {
  max-width:70%;
  padding:10px 14px;
  border-radius:12px;
  margin-bottom:10px;
  line-height:1.4;
  font-size:15px;
}
.sent {
  background:#0078ff;
  color:#fff;
  align-self:flex-end;
  border-bottom-right-radius:4px;
}
.received {
  background:#e4e6eb;
  color:#111;
  align-self:flex-start;
  border-bottom-left-radius:4px;
}
.input-area {
  display:flex;
  padding:10px;
  background:#fff;
  box-shadow:0 -1px 4px rgba(0,0,0,0.1);
}
.input-area input {
  flex:1;
  padding:10px 12px;
  border:1px solid #ccc;
  border-radius:20px;
  font-size:15px;
  outline:none;
}
.input-area button {
  background:#000;
  color:#fff;
  border:none;
  border-radius:20px;
  padding:10px 18px;
  margin-left:8px;
  cursor:pointer;
  transition:0.3s;
}
.input-area button:hover {
  background:#333;
}
.user-item {
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:12px 15px;
  border-bottom:1px solid #eee;
  cursor:pointer;
  transition: background 0.2s;
}
.user-item:hover {
  background:#f0f8ff;
}
.user-info {
  display:flex;
  align-items:center;
  gap:12px;
}
.user-info img {
  width:45px;
  height:45px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #0099ff;
}
.user-info strong {
  font-weight:600;
  font-size:16px;
}
.user-info span {
  color:#888;
  font-size:13px;
}
.new-msg-badge {
  background:red;
  color:white;
  padding:3px 7px;
  border-radius:10px;
  font-size:12px;
}

/* -------- STYLE DES MESSAGES NON LUS -------- */
.unread {
  background: linear-gradient(90deg, #e0f3ff 0%, #f5faff 100%);
  animation: highlight 2s ease-in-out infinite alternate;
}
@keyframes highlight {
  from { background-color: #e0f3ff; }
  to { background-color: #d2efff; }
}
.unread strong {
  font-weight:700;
  color:#000;
}
.unread span {
  font-weight:600;
  color:#000;
}
</style>
</head>
<body>

<header>
  <h2 id="chatTitle">ðŸ“¨ Messagerie</h2>
  <button onclick="logout()" style="background:#ff5555;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;">
    DÃ©connexion
  </button>
</header>

<div class="inbox-container" id="inboxList"></div>
<div class="chat-box" id="chatBox" style="display:none;"></div>
<div class="input-area" id="chatInputArea" style="display:none;">
  <input type="text" id="msgInput" placeholder="Ã‰crivez un message...">
  <button id="sendBtn">Envoyer</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const params = new URLSearchParams(location.search);
const receiverId = parseInt(params.get("receiver"));
const token = localStorage.getItem("token");
const userRaw = localStorage.getItem("user");

if(!token || !userRaw) {
  alert("Veuillez vous connecter.");
  window.location.href="/login";
}

const user = JSON.parse(userRaw);
const userId = user.id;
const socket = io("http://127.0.0.1:5000");

// Rejoindre le canal utilisateur
socket.emit("join", { user_id: userId });

function logout() {
  localStorage.clear();
  window.location.href="/login";
}

// ---------------- BoÃ®te de rÃ©ception ----------------
async function loadInbox() {
  try {
    const res = await fetch(`http://127.0.0.1:5000/api/conversations`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(res.status===401){ logout(); return; }
    const conversations = await res.json();
    renderInbox(conversations);
  } catch(e){
    console.error(e);
    document.getElementById('inboxList').innerHTML="<p>Erreur chargement inbox</p>";
  }
}

function renderInbox(conversations) {
  const inboxDiv = document.getElementById('inboxList');
  inboxDiv.innerHTML = '';
  if (!conversations.length) {
    inboxDiv.innerHTML = "<p>Aucune conversation</p>";
    return;
  }

  conversations.forEach(c => {
    const div = document.createElement('div');
    const hasUnread = c.unread_count && c.unread_count > 0;
    div.className = 'user-item' + (hasUnread ? ' unread' : '');
    div.id = 'conv-' + c.peer_id;

    div.innerHTML = `
      <div class="user-info">
        <img src="${c.avatar || '/static/default-avatar.png'}" alt="">
        <div>
          <strong>${c.peer_name}</strong><br>
          <span>${c.last_message || ''}</span>
        </div>
      </div>
      <span class="new-msg-badge" style="display:${hasUnread ? 'inline-block' : 'none'};">
        ${hasUnread ? c.unread_count : ''}
      </span>
    `;

    div.addEventListener('click', () => {
      fetch(`http://127.0.0.1:5000/api/mark_read/${c.peer_id}`, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` }
      });
      window.location.href = `/chat.html?receiver=${c.peer_id}`;
    });

    inboxDiv.appendChild(div);
  });
}


// ---------------- Chat direct ----------------
async function loadMessages(rId) {
  try {
    const res = await fetch(`http://127.0.0.1:5000/api/messages/${rId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    if(res.status===401){ logout(); return; }
    const messages = await res.json();
    const box = document.getElementById('chatBox');
    box.innerHTML = '';
    messages.forEach(m=>{
      const div = document.createElement('div');
      div.className='message '+(m.sender_id===userId?'sent':'received');
      div.textContent = m.content;
      box.appendChild(div);
    });
    box.scrollTop = box.scrollHeight;
  } catch(e){ console.error(e); }
}

async function sendMessage() {
  const content = document.getElementById('msgInput').value.trim();
  if(!content) return;
  const res = await fetch("http://127.0.0.1:5000/api/messages", {
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":`Bearer ${token}`},
    body: JSON.stringify({receiver_id:receiverId, content})
  });
  if(res.ok){
    document.getElementById('msgInput').value='';
    loadMessages(receiverId);
  }
}

// ---------------- Initialisation ----------------
if(receiverId && !isNaN(receiverId)){
  document.getElementById('chatTitle').textContent="Chat avec l'utilisateur "+receiverId;
  document.getElementById('inboxList').style.display='none';
  document.getElementById('chatBox').style.display='flex';
  document.getElementById('chatInputArea').style.display='flex';

  socket.emit('join',{user_id:userId, peer_id:receiverId});
  loadMessages(receiverId);
  setInterval(()=>loadMessages(receiverId),4000);

  document.getElementById('sendBtn').addEventListener('click',sendMessage);
  document.getElementById('msgInput').addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

} else {
  loadInbox();
  socket.on('receive_message', msg=>{
    if(msg.receiver_id===userId){
      loadInbox(); 
      if(Notification.permission==='granted'){
        new Notification(`Nouveau message de ${msg.sender_name||'un client'}`,{body:msg.content});
      }
    }
  });
  if(Notification.permission!=='granted'){ Notification.requestPermission(); }
}
</script>
</body>
</html>
