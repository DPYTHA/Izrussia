<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vendre un article ‚Äî Izrussia</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f9fafc; --text:#0b0b0b; --muted:#7a7a7a;
  --primary:#000; --accent:#ff6600;
}
*{box-sizing:border-box;font-family:'Poppins',sans-serif;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column;align-items:center;}
header{width:100%; background:var(--primary); color:#fff; display:flex; justify-content:space-between; align-items:center; padding:12px 20px; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
header img{height:38px; border-radius:6px;}
header .username{font-weight:600; font-size:16px;}
.page{width:100%; max-width:520px; background:#fff; border-radius:20px; box-shadow:0 4px 12px rgba(0,0,0,0.1); padding:24px; margin:20px 0;}
h1{font-size:24px; font-weight:700; text-align:center; margin-bottom:20px;}
form{display:flex; flex-direction:column; gap:16px;}
label{font-weight:600; font-size:14px; color:var(--text);}
input, select, textarea{padding:12px; border:1px solid #ddd; border-radius:12px; font-size:14px; width:100%;}
textarea{min-height:80px; resize:none;}
.photos-preview{display:flex; flex-wrap:wrap; gap:10px; margin-top:5px;}
.photos-preview img{width:80px; height:80px; object-fit:cover; border-radius:10px; border:1px solid #ddd;}
.btn{padding:12px; border-radius:12px; font-weight:600; font-size:15px; cursor:pointer; transition:0.2s ease; border:none;}
.btn.primary{background:var(--primary); color:#fff;}
.btn.primary:hover{background:#222;}
.alert{padding:12px; border-radius:12px; font-size:14px; margin-top:15px; display:none;}
.fee-display{font-size:14px; color:var(--accent); margin-top:-8px; margin-bottom:8px; display:none;}
.modal {position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;}
.modal.hidden { display: none; }
.modal-content {background: white; padding: 20px; border-radius: 10px; text-align: center;}
.modal-content button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
.modal-content button:hover { opacity: 0.8; }
:root { --accent:#ff6600; --primary:#000; }

.tabbar {
  position: fixed;
  bottom: 0; left: 0; width: 100%;
  background: var(--primary); /* noir */
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 8px 0;
  border-top-left-radius: 20px;
  border-top-right-radius: 20px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.25);
  z-index: 1000;
}

.tabbar button {
  background: none; border: none; color: #fff;
  display: flex; flex-direction: column; align-items: center;
  font-size: 13px; cursor: pointer; flex: 1; padding: 8px 0;
  transition: all 0.3s ease;
}

.tabbar button i { font-size: 18px; margin-bottom: 3px; }

.tabbar button:hover { color: var(--accent); transform: translateY(-3px); }

.tabbar button.active { color: var(--accent); }

@media(min-width:768px) {
  .tabbar button { font-size:14px; }
  .tabbar button i { font-size:20px; }
}

/* pour que le contenu ne soit pas cach√© derri√®re la tabbar */
body { padding-bottom: 70px; }

@media(max-width:480px){.page{border-radius:12px; padding:16px;}h1{font-size:20px;}.btn{font-size:14px; padding:10px;}header .username{font-size:14px;}}
</style>
</head>
<body>

<header>
<img src="{{ url_for('static', filename='uploads/izlogo.png') }}" alt="Logo IZRUSSIA">
  <div class="username" id="userName">Bonjour, Utilisateur</div>
</header>

<div class="page">
  <h1>Vendre un article</h1>
  <form id="sellForm">
    <label for="title">Titre</label>
    <input type="text" name="title" id="title" placeholder="Ex : iPhone 14" required>

    <label for="price">Prix (FCFA)</label>
    <input type="number" name="price" id="price" required>
    <div id="feeDisplay" class="fee-display"></div>

    <label for="category">Cat√©gorie</label>
    <input type="text" name="category" id="category" placeholder="Ex : T√©l√©phones">

    <label for="condition">√âtat</label>
    <select name="condition" id="condition">
      <option value="Neuf">Neuf</option>
      <option value="Occasion">Occasion</option>
    </select>

    <label for="city">Ville (Localisation complete )</label>
    <input type="text" name="city" id="city" placeholder="Ex : Abidjan ,koumassi -pharmacie fanny">

    <label for="description">Description & Caracteristiques</label>
    <textarea name="description" id="description" placeholder="
√âcran Taille : 6,8 pouces (Dynamic AMOLED 2X)
R√©solution : QHD+ (3088 √ó 1440 px)
Taux de rafra√Æchissement : 120 Hz
Protection : Corning Gorilla Glass Armor

üîπ Performances
Processeur : Qualcomm Snapdragon 8 Gen 3
RAM : 12 Go
Stockage interne : 256 Go (non extensible)
Syst√®me : Android 14, One UI 6.1

üîπ Appareil photo
Arri√®re : Quadruple capteur (200 MP + 12 MP + 10 MP + 10 MP)
Avant : 12 MP
Vid√©o : 8K √† 30 fps / 4K √† 60 fps

üîπ Batterie
Capacit√© : 5000 mAh
Charge rapide : 45 W
Charge sans fil : Oui
Autonomie moyenne : 1,5 jour


"></textarea>

    <label for="photos">Photos (max 5)</label>
    <input type="file" name="photos" id="photos" accept="image/*" multiple>
    <div class="photos-preview" id="photoPreview"></div>

    <button type="submit" id="publishBtn" class="btn primary">Publier</button>
    <div id="alertBox" class="alert"></div>
  </form>
</div>

<!-- ‚úÖ MODAL DE PAIEMENT -->
<div id="paymentModal" class="modal hidden">
  <div class="modal-content">
    <h3 id="modalMessage"></h3><br>
    <button id="payBtn">Payer maintenant</button>
    <button id="closeModal" style="margin-left:10px;background:#444;">Fermer</button>
  </div>
</div>
<!-- Barre de navigation en bas -->
<nav class="tabbar">
  <button onclick="window.location.href='{{ url_for('dashboard_page') }}'">
    <i class="fas fa-home"></i><span>Accueil</span>
  </button>
  <button class="active" onclick="window.location.href='{{ url_for('sell_page') }}'">
    <i class="fas fa-store"></i><span>Vendre</span>
  </button>
  <button onclick="window.location.href='{{ url_for('profile') }}'">
    <i class="fas fa-user"></i><span>Profil</span>
  </button>
  <button onclick="window.location.href='{{ url_for('logout') }}'">
    <i class="fas fa-sign-out-alt"></i><span>Quitter</span>
  </button>
</nav>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem('token');
  const user = JSON.parse(localStorage.getItem('user'));
  if(!token){ window.location.href = '/login'; return; }
  if(user && user.first_name){ 
    document.getElementById('userName').textContent = `Bonjour, ${user.first_name}`; 
  }
});

const photoInput = document.getElementById("photos");
const photoPreview = document.getElementById("photoPreview");
const alertBox = document.getElementById("alertBox");
const priceInput = document.getElementById("price");
const feeDisplay = document.getElementById("feeDisplay");
const publishBtn = document.getElementById("publishBtn");

// Aper√ßu photos
photoInput.addEventListener("change", (e) => {
  photoPreview.innerHTML = "";
  const files = Array.from(e.target.files).slice(0,5);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = (event) => {
      const img = document.createElement("img");
      img.src = event.target.result;
      photoPreview.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});

// Calcul 5%
priceInput.addEventListener("input", () => {
  const value = parseFloat(priceInput.value);
  if(!isNaN(value) && value > 0){
    const fee = (value*0.05).toFixed(0);
    feeDisplay.style.display="block";
    feeDisplay.textContent = `üí∞ 5% du montant √† solder : ${fee} FCFA`;
    publishBtn.textContent = `Publier (Payer ${fee} FCFA)`;
  } else {
    feeDisplay.style.display="none";
    publishBtn.textContent = "Publier";
  }
});

// Soumission du formulaire
document.getElementById("sellForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const token = localStorage.getItem("token");
  if (!token) {
    alert("Veuillez vous connecter avant de publier un article.");
    return;
  }

  const formData = new FormData(e.target);

  try {
    // 1Ô∏è‚É£ Publier l'article
    const res = await fetch("http://127.0.0.1:5000/api/sell", {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: formData
    });

    const data = await res.json().catch(() => ({}));
    if(!res.ok){
      alert(`Erreur ${res.status}: ${data.error || '√âchec de publication'}`);
      return;
    }

    const articleId = data.article.id;
    const price = parseFloat(formData.get("price"));
    const fee = (price * 0.05).toFixed(0);

    // 2Ô∏è‚É£ Afficher le modal
    const modal = document.getElementById("paymentModal");
    const message = document.getElementById("modalMessage");
    const payBtn = document.getElementById("payBtn");
    const closeBtn = document.getElementById("closeModal");

    message.innerHTML = `‚úÖ Votre article a √©t√© enregistr√©.<br><br>üí∞ Veuillez solder <strong>${fee} FCFA</strong> pour valider la publication.`;
    modal.classList.remove("hidden");

    // 3Ô∏è‚É£ Bouton paiement : appelle le backend pour cr√©er la transaction CinetPay
    payBtn.onclick = async () => {
      try {
        const resp = await fetch("http://127.0.0.1:5000/api/create_payment", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            amount: fee,
            desc: "Paiement publication article",
            article_id: articleId
          })
        });
        const result = await resp.json();
        if(result.payment_url){
          window.location.href = result.payment_url;
        } else {
          alert("Impossible de cr√©er le paiement. R√©essayez.");
        }
      } catch(err){
        console.error("Erreur paiement:", err);
        alert("Erreur r√©seau lors de la cr√©ation du paiement.");
      }
    };

    // 4Ô∏è‚É£ Fermer le modal
    closeBtn.onclick = () => modal.classList.add("hidden");
    window.onclick = (event) => { if(event.target === modal) modal.classList.add("hidden"); };

    // 5Ô∏è‚É£ Reset formulaire
    e.target.reset();
    document.getElementById("photoPreview").innerHTML = "";
    document.getElementById("feeDisplay").style.display = "none";
    document.getElementById("publishBtn").textContent = "Publier";

  } catch(err){
    console.error("Erreur r√©seau:", err);
    alert("‚ùå Une erreur r√©seau ou serveur est survenue.");
  }
});

</script>


</body>
</html>
