<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Izrussia — Tableau de bord</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fff; --text:#0b0b0b; --muted:#7a7a7a;
  --primary:#000; --accent:#ff6600; --header-bg:#f1f1f1;
}
*{box-sizing:border-box; font-family:'Poppins',sans-serif;}
body{margin:0; background:var(--bg); color:var(--text); display:flex; flex-direction:column; min-height:100vh;}
header{background:var(--header-bg); display:flex; justify-content:space-between; align-items:center; padding:12px 20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
header .logo{font-size:26px; font-weight:800; color:var(--primary); display:flex; align-items:center; gap:10px;}
header .logo img{width:38px; height:38px; border-radius:8px;}
header .user{font-size:16px; font-weight:600; color:var(--accent);}
main{flex:1; display:flex; overflow:hidden;}
.app-content{flex:2; padding:20px; overflow-y:auto;}
.ads{flex:1; background:#fafafa; border-left:1px solid #ddd; padding:20px; overflow-y:auto;}
h2{font-weight:700; margin-top:0;}
.search-bar{display:flex; align-items:center; gap:10px; margin-bottom:20px;}
.search-bar input{flex:1; padding:10px 15px; border:1px solid #ccc; border-radius:25px; font-size:15px; outline:none;}
.search-bar button{background:var(--accent); color:#fff; border:none; border-radius:25px; padding:10px 18px; cursor:pointer; font-weight:600;}
.search-bar button:hover{background:#e55c00;}
.chips{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0;}
.chip{padding:8px 14px; border-radius:20px; border:1px solid #ccc; background:#f9f9f9; cursor:pointer; transition:0.2s;}
.chip:hover{background:var(--accent); color:#fff;}
.grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:15px;}
.card{display:block; border:1px solid #ddd; border-radius:10px; overflow:hidden; text-decoration:none; color:inherit; background:#fff; transition:transform 0.2s;}
.card:hover{transform:translateY(-5px);}
.card-image{width:100%; height:140px; background:#f2f2f2; display:flex; align-items:center; justify-content:center;}
.card-image img{width:100%; height:100%; object-fit:cover;}
.card-body{padding:10px;}
.card-title{font-weight:600; font-size:16px;}
.card-desc{color:var(--muted); font-size:13px; margin:6px 0;}
.card-footer{display:flex; justify-content:space-between; align-items:center; font-size:13px; color:var(--muted);}
.tabbar{position:fixed; bottom:0; left:0; width:100%; background:var(--primary); display:flex; justify-content:space-around; align-items:center; padding:8px 0; border-top-left-radius:20px; border-top-right-radius:20px; box-shadow:0 -2px 10px rgba(0,0,0,0.25); z-index:1000;}
.tabbar button{background:none; border:none; color:#fff; display:flex; flex-direction:column; align-items:center; font-size:13px; cursor:pointer; flex:1; padding:8px 0; transition:all 0.3s ease;}
.tabbar button i{font-size:18px; margin-bottom:3px;}
.tabbar button:hover{color:var(--accent); transform:translateY(-3px);}
.tabbar button.active{color:var(--accent);}
@media(min-width:768px){.tabbar button{font-size:14px;}.tabbar button i{font-size:20px;}}
.chat-btn { position:relative; background:#ff6600; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer;}
.badge { position:absolute; top:-5px; right:-5px; background:red; color:#fff; font-size:12px; padding:2px 6px; border-radius:50%; display:none; }
</style>
</head>
<body>
<header>
  <div class="logo">
    <img src="{{ url_for('static', filename='uploads/izlogo.png') }}" alt="Logo IZRUSSIA">
    IZRUSSIA
  </div>
  <div class="user" id="userName">Bonjour, Utilisateur</div>
  <div class="header-right">
    <button id="chatBtn" class="chat-btn">
      💬 Messages
      <span id="msgBadge" class="badge">0</span>
    </button>
  </div>
</header>
<main>
  <div class="app-content">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher un article, une catégorie..." />
      <button onclick="searchArticles()">Rechercher</button>
    </div>
    <section class="categories">
      <h2>Catégories</h2>
      <div class="chips" id="chips"></div>
    </section>
    <section class="articles">
      <h2>Tous les articles</h2>
      <div id="articleList" class="grid"></div>
    </section>
  </div>
  <aside class="ads">
    <h3>Publicités</h3>
   <div class="ad">
  <img src="{{ url_for('static', filename='uploads/izi.png') }}" alt="Pub 1" style="width:100%;height:220px;object-fit:cover;border-radius:10px;">
</div>
<div class="ad" style="margin-top:10px;">
  <img src="{{ url_for('static', filename='uploads/pub3.png') }}" alt="Pub 3" style="width:100%;height:220px;object-fit:cover;border-radius:10px;">
</div>
<!-- 🔹 Nouvelle section : Contact & Partage -->
  <div class="contact-share" style="margin-top:20px; text-align:center; background:#f9f9f9; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
    <h4 style="margin-bottom:10px; color:#333;">Besoin d'aide ou envie de partager ?</h4>

    <!-- Bouton WhatsApp -->
    <button onclick="window.open('https://wa.me/79879040719','_blank')" 
            style="background:#25D366;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin:5px;font-weight:600;">
      💬 Contactez-nous (WhatsApp)
    </button>

    <!-- Bouton Partage -->
    <button onclick="shareSite()" 
            style="background:#0078ff;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin:5px;font-weight:600;">
      🔗 Partagez notre site
    </button>
  </div>
  <div class="ad" style="margin-top:10px;">
  <img src="{{ url_for('static', filename='uploads/pub2.png') }}" alt="Pub 2" style="width:100%;height:220px;object-fit:cover;border-radius:10px;">
</div>
  </aside>
</main>
<nav class="tabbar">
  <button onclick="window.location.href='{{ url_for('dashboard_page') }}'">
    <i class="fas fa-home"></i><span>Accueil</span>
  </button>
  <button onclick="window.location.href='{{ url_for('sell_page') }}'">
    <i class="fas fa-store"></i><span>Vendre</span>
  </button>
  <button onclick="window.location.href='{{ url_for('profile_page') }}'">
    <i class="fas fa-user"></i><span>Profil</span>
  </button>
  <button onclick="window.location.href='{{ url_for('logout') }}'">
    <i class="fas fa-sign-out-alt"></i><span>Quitter</span>
  </button>
</nav>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const token = localStorage.getItem('token');
const user = JSON.parse(localStorage.getItem('user'));
if(!token || !user) window.location.href = '/login';
const userId = parseInt(user.id);

document.getElementById('userName').textContent = `Bonjour, ${user.first_name || 'Utilisateur'}`;

// Badge messages
const msgBadge = document.getElementById('msgBadge');
const chatBtn = document.getElementById('chatBtn');
chatBtn.addEventListener('click', () => { window.location.href = '/inbox.html'; });

// Socket.IO
const socket = io("https://izrussia-production.up.railway.app");
socket.emit("join", { user_id: userId });

// --- Fonction pour mettre à jour le badge ---
async function updateBadge() {
  try {
    const res = await fetch('https://izrussia-production.up.railway.app/api/unread_count', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if(res.ok){
      const data = await res.json();
      msgBadge.textContent = data.count; // "count" côté backend
      msgBadge.style.display = data.count > 0 ? 'inline-block' : 'none';
    }
  } catch(err){
    console.error(err);
  }
}

// --- Fonction pour marquer messages comme lus ---
// --- Au chargement du chat / inbox ---
const receiverId = localStorage.getItem('currentChatId'); // ou récupère depuis l'URL
if(receiverId){
    markMessagesRead(receiverId);
}

// --- Fonction pour marquer comme lus et décrémenter badge ---
async function markMessagesRead(peerId) {
    if(!peerId) return;
    try {
        const res = await fetch(`https://izrussia-production.up.railway.app/api/mark_read/${peerId}`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if(res.ok){
            // Recharge le nombre de messages non lus
            updateBadge();
        }
    } catch(e){
        console.error(e);
    }
}

// --- Temps réel ---
socket.on('receive_message', msg => {
    if(msg.receiver_id === userId){
        updateBadge();
        if(Notification.permission === "granted"){
            new Notification(`Nouveau message de ${msg.sender_name || 'Utilisateur'}`, { body: msg.content });
        }
    }
});

// --- Initialisation ---
updateBadge();

// --- Articles ---
let allArticles = [];
document.addEventListener("DOMContentLoaded", () => fetchArticles(token));

async function fetchArticles(token){
  try{
    const res = await fetch('https://izrussia-production.up.railway.app/api/articles', {
      headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
    });
    if(!res.ok){
      if(res.status === 401){ alert('Session expirée'); logout(); }
      throw new Error('Erreur API');
    }
    const list = await res.json();
    allArticles = list;
    renderArticles(list);
    renderChips(list);
  } catch(err){
    console.error(err);
    document.getElementById('articleList').innerHTML='<p>Impossible de charger les articles.</p>';
  }
}

function renderChips(articles){
  const categories = [...new Set(articles.map(a=>a.category || 'Autres'))];
  const chips = document.getElementById('chips');
  chips.innerHTML='';
  categories.forEach(c=>{
    const btn=document.createElement('button');
    btn.className='chip';
    btn.textContent=c;
    btn.addEventListener('click', ()=>filterByCategory(c));
    chips.appendChild(btn);
  });
}

function filterByCategory(c){
  renderArticles(allArticles.filter(a=>(a.category||'Autres')===c));
}

function renderArticles(list){
  const container = document.getElementById('articleList');
  container.innerHTML='';
  if(list.length===0){ container.innerHTML='<p>Aucun article trouvé.</p>'; return; }
  list.forEach(a=>{
    const image = a.photos && a.photos.length ? a.photos[0] : '/static/assets/placeholder.png';
    const card = document.createElement('a');
    card.className='card';
    card.href=`/details?id=${a.id}`;
    card.innerHTML=`
      <div class="card-image"><img src="${image}" alt="${a.title}"></div>
      <div class="card-body">
        <div class="card-title">${a.title}</div>
        <div class="card-desc">${a.condition||''}</div>
        <div class="card-footer">
          <strong>${a.price} FCFA</strong>
          <span class="location">📍 ${a.city||''}</span>
        </div>
      </div>`;
    container.appendChild(card);
  });
}

function logout(){
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  window.location.href='/login';
}

// Notifications
if(Notification.permission !== "granted") Notification.requestPermission();
</script>

<script>
function shareSite() {
  const siteURL = "https://izrussia-production.up.railway.app"; // 🔹 Remplace par ton vrai lien
  if (navigator.share) {
    navigator.share({
      title: "Izrussia",
      text: "Découvre Izrussia — achats sécurisés et garantis !",
      url: siteURL
    });
  } else {
    alert("Partagez ce lien avec vos amis : " + siteURL);
  }
}
</script>

</body>
</html>
