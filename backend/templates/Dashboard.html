<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Izrussia ‚Äî Tableau de bord</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#fff; --text:#0b0b0b; --muted:#7a7a7a;
  --primary:#000; --accent:#ff6600; --header-bg:#f1f1f1;
}
*{box-sizing:border-box; font-family:'Poppins',sans-serif;}
body{margin:0; background:var(--bg); color:var(--text); display:flex; flex-direction:column; min-height:100vh;}
header{background:var(--header-bg); display:flex; justify-content:space-between; align-items:center; padding:12px 20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
header .logo{font-size:26px; font-weight:800; color:var(--primary); display:flex; align-items:center; gap:10px;}
header .logo img{width:38px; height:38px; border-radius:8px;}
header .user{font-size:16px; font-weight:600; color:var(--accent);}
main{flex:1; display:flex; overflow:hidden;}
.app-content{flex:2; padding:20px; overflow-y:auto;}
.ads{flex:1; background:#fafafa; border-left:1px solid #ddd; padding:20px; overflow-y:auto;}
h2{font-weight:700; margin-top:0;}
.search-bar{display:flex; align-items:center; gap:10px; margin-bottom:20px;}
.search-bar input{flex:1; padding:10px 15px; border:1px solid #ccc; border-radius:25px; font-size:15px; outline:none;}
.search-bar button{background:var(--accent); color:#fff; border:none; border-radius:25px; padding:10px 18px; cursor:pointer; font-weight:600;}
.search-bar button:hover{background:#e55c00;}
.chips{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0;}
.chip{padding:8px 14px; border-radius:20px; border:1px solid #ccc; background:#f9f9f9; cursor:pointer; transition:0.2s;}
.chip:hover{background:var(--accent); color:#fff;}
.grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:15px;}
.card{display:block; border:1px solid #ddd; border-radius:10px; overflow:hidden; text-decoration:none; color:inherit; background:#fff; transition:transform 0.2s;}
.card:hover{transform:translateY(-5px);}
.card-image{width:100%; height:140px; background:#f2f2f2; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;}
.card-image img{width:100%; height:100%; object-fit:cover; transition:transform 0.3s ease;}
.card:hover .card-image img{transform:scale(1.05);}
.card-image .placeholder{color:#aaa; font-size:14px; text-align:center; padding:20px;}
.card-body{padding:10px;}
.card-title{font-weight:600; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.card-desc{color:var(--muted); font-size:13px; margin:6px 0;}
.card-footer{display:flex; justify-content:space-between; align-items:center; font-size:13px; color:var(--muted);}
.tabbar{position:fixed; bottom:0; left:0; width:100%; background:var(--primary); display:flex; justify-content:space-around; align-items:center; padding:8px 0; border-top-left-radius:20px; border-top-right-radius:20px; box-shadow:0 -2px 10px rgba(0,0,0,0.25); z-index:1000;}
.tabbar button{background:none; border:none; color:#fff; display:flex; flex-direction:column; align-items:center; font-size:13px; cursor:pointer; flex:1; padding:8px 0; transition:all 0.3s ease;}
.tabbar button i{font-size:18px; margin-bottom:3px;}
.tabbar button:hover{color:var(--accent); transform:translateY(-3px);}
.tabbar button.active{color:var(--accent);}
@media(min-width:768px){.tabbar button{font-size:14px;}.tabbar button i{font-size:20px;}}
.chat-btn { position:relative; background:#ff6600; border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer;}
.badge { position:absolute; top:-5px; right:-5px; background:red; color:#fff; font-size:12px; padding:2px 6px; border-radius:50%; display:none; }

/* Style pour les images cass√©es */
.card-image img:before {
  content: "üñºÔ∏è Image non disponible";
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #f8f8f8;
  color: #666;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
}
</style>
</head>
<body>
<header>
  <div class="logo">
    <img src="{{ url_for('static', filename='uploads/izlogo.png') }}" alt="Logo IZRUSSIA">
    IZRUSSIA
  </div>
  <div class="user" id="userName">Bonjour, Utilisateur</div>
  <div class="header-right">
    <button id="chatBtn" class="chat-btn">
      üí¨ Messages
      <span id="msgBadge" class="badge">0</span>
    </button>
  </div>
</header>
<main>
  <div class="app-content">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Rechercher un article, une cat√©gorie..." />
      <button onclick="searchArticles()">Rechercher</button>
    </div>
    <section class="categories">
      <h2>Cat√©gories</h2>
      <div class="chips" id="chips"></div>
    </section>
    <section class="articles">
      <h2>Tous les articles</h2>
      <div id="articleList" class="grid"></div>
    </section>
  </div>
  <aside class="ads">
    <h3>Publicit√©s</h3>
   <div class="ad">
  <img src="{{ url_for('static', filename='uploads/izi.png') }}" alt="Pub 1" style="width:100%;height:220px;object-fit:cover;border-radius:10px;">
</div>
<div class="ad" style="margin-top:10px;">
  <img src="{{ url_for('static', filename='uploads/pub3.png') }}" alt="Pub 3" style="width:100%;height:220px;object-fit:cover;border-radius:10px;">
</div>
<!-- üîπ Nouvelle section : Contact & Partage -->
  <div class="contact-share" style="margin-top:20px; text-align:center; background:#f9f9f9; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
    <h4 style="margin-bottom:10px; color:#333;">Besoin d'aide ou envie de partager ?</h4>

    <!-- Bouton WhatsApp -->
    <button onclick="window.open('https://wa.me/79879040719','_blank')" 
            style="background:#25D366;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin:5px;font-weight:600;">
      üí¨ Contactez-nous (WhatsApp)
    </button>

    <!-- Bouton Partage -->
    <button onclick="shareSite()" 
            style="background:#0078ff;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin:5px;font-weight:600;">
      üîó Partagez notre site
    </button>
  </div>
  <div class="ad" style="margin-top:10px;">
  <img src="{{ url_for('static', filename='uploads/pub2.png') }}" alt="Pub 2" style="width:100%;height:220px;object-fit:cover;border-radius:10px;">
</div>
  </aside>
</main>
<nav class="tabbar">
  <button onclick="window.location.href='{{ url_for('dashboard_page') }}'">
    <i class="fas fa-home"></i><span>Accueil</span>
  </button>
  <button onclick="window.location.href='{{ url_for('sell_page') }}'">
    <i class="fas fa-store"></i><span>Vendre</span>
  </button>
  <button onclick="window.location.href='{{ url_for('profile_page') }}'">
    <i class="fas fa-user"></i><span>Profil</span>
  </button>
  <button onclick="window.location.href='{{ url_for('logout') }}'">
    <i class="fas fa-sign-out-alt"></i><span>Quitter</span>
  </button>
</nav>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const token = localStorage.getItem('token');
const user = JSON.parse(localStorage.getItem('user'));
if(!token || !user) window.location.href = '/login';
const userId = parseInt(user.id);

document.getElementById('userName').textContent = `Bonjour, ${user.first_name || 'Utilisateur'}`;

// Badge messages
const msgBadge = document.getElementById('msgBadge');
const chatBtn = document.getElementById('chatBtn');
chatBtn.addEventListener('click', () => { window.location.href = '/inbox.html'; });

// Socket.IO
const socket = io("https://izrussia-production.up.railway.app");
socket.emit("join", { user_id: userId });

// --- Fonction pour mettre √† jour le badge ---
async function updateBadge() {
  try {
    const res = await fetch('https://izrussia-production.up.railway.app/api/unread_count', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    if(res.ok){
      const data = await res.json();
      msgBadge.textContent = data.count;
      msgBadge.style.display = data.count > 0 ? 'inline-block' : 'none';
    }
  } catch(err){
    console.error(err);
  }
}

// --- Fonction pour marquer messages comme lus ---
async function markMessagesRead(peerId) {
    if(!peerId) return;
    try {
        const res = await fetch(`https://izrussia-production.up.railway.app/api/mark_read/${peerId}`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        if(res.ok){
            updateBadge();
        }
    } catch(e){
        console.error(e);
    }
}

// --- Temps r√©el ---
socket.on('receive_message', msg => {
    if(msg.receiver_id === userId){
        updateBadge();
        if(Notification.permission === "granted"){
            new Notification(`Nouveau message de ${msg.sender_name || 'Utilisateur'}`, { body: msg.content });
        }
    }
});

// --- Initialisation ---
updateBadge();

// --- Articles ---
let allArticles = [];
document.addEventListener("DOMContentLoaded", () => fetchArticles(token));

async function fetchArticles(token){
  try{
    const res = await fetch('https://izrussia-production.up.railway.app/api/articles', {
      headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }
    });
    
    if(!res.ok){
      if(res.status === 401){ 
        alert('Session expir√©e'); 
        logout(); 
      }
      throw new Error('Erreur API: ' + res.status);
    }
    
    const list = await res.json();
    console.log('Articles charg√©s:', list); // Debug
    
    // Debug des images
    list.forEach((article, index) => {
      console.log(`Article ${index}:`, {
        title: article.title,
        photos: article.photos,
        hasPhotos: article.photos && article.photos.length > 0
      });
    });
    
    allArticles = list;
    renderArticles(list);
    renderChips(list);
    
  } catch(err){
    console.error('Erreur chargement articles:', err);
    document.getElementById('articleList').innerHTML = 
      '<p style="text-align:center;color:#666;padding:20px;">Impossible de charger les articles. V√©rifiez votre connexion.</p>';
  }
}

function renderChips(articles){
  const categories = [...new Set(articles.map(a=>a.category || 'Autres'))];
  const chips = document.getElementById('chips');
  chips.innerHTML='';
  categories.forEach(c=>{
    const btn=document.createElement('button');
    btn.className='chip';
    btn.textContent=c;
    btn.addEventListener('click', ()=>filterByCategory(c));
    chips.appendChild(btn);
  });
}

function filterByCategory(c){
  renderArticles(allArticles.filter(a=>(a.category||'Autres')===c));
}

// --- FONCTION RENDERARTICLES CORRIG√âE POUR CLOUDINARY ---
function renderArticles(list){
  const container = document.getElementById('articleList');
  container.innerHTML='';
  
  if(list.length===0){ 
    container.innerHTML='<p style="text-align:center;color:#666;padding:20px;">Aucun article trouv√©.</p>'; 
    return; 
  }
  
  list.forEach(a=>{
    // Gestion robuste des images Cloudinary et locales
    let imageUrl = '/static/assets/placeholder.png'; // Image par d√©faut
    
    if(a.photos && a.photos.length > 0){
      const firstPhoto = a.photos[0];
      
      // Si c'est une URL Cloudinary compl√®te
      if(firstPhoto.startsWith('http')){
        imageUrl = firstPhoto;
      } 
      // Si c'est un nom de fichier local
      else if(firstPhoto.includes('.') || firstPhoto.length > 10){
        imageUrl = `/static/uploads/${firstPhoto}`;
      }
    }
    
    const card = document.createElement('a');
    card.className='card';
    card.href=`/details?id=${a.id}`;
    card.innerHTML=`
      <div class="card-image">
        <img src="${imageUrl}" 
             alt="${a.title}" 
             loading="lazy"
             onerror="this.onerror=null; this.src='/static/assets/placeholder.png'; this.alt='Image non disponible'">
      </div>
      <div class="card-body">
        <div class="card-title">${a.title || 'Sans titre'}</div>
        <div class="card-desc">${a.condition || ''}${a.category ? ' ‚Ä¢ ' + a.category : ''}</div>
        <div class="card-footer">
          <strong>${a.price ? a.price + ' FCFA' : 'Prix non sp√©cifi√©'}</strong>
          <span class="location">üìç ${a.city || ''}</span>
        </div>
      </div>`;
    container.appendChild(card);
  });
}

function searchArticles(){
  const query = document.getElementById('searchInput').value.toLowerCase();
  if(!query.trim()){
    renderArticles(allArticles);
    return;
  }
  
  const filtered = allArticles.filter(a=>
    (a.title && a.title.toLowerCase().includes(query)) ||
    (a.category && a.category.toLowerCase().includes(query)) ||
    (a.description && a.description.toLowerCase().includes(query)) ||
    (a.city && a.city.toLowerCase().includes(query))
  );
  renderArticles(filtered);
}

function logout(){
  localStorage.removeItem('token');
  localStorage.removeItem('user');
  window.location.href='/login';
}

// Script de debug pour v√©rifier les images
function debugImages() {
  console.log('=== DEBUG IMAGES ===');
  const cards = document.querySelectorAll('.card');
  cards.forEach((card, index) => {
    const img = card.querySelector('img');
    console.log(`Carte ${index}:`, {
      src: img.src,
      naturalWidth: img.naturalWidth,
      naturalHeight: img.naturalHeight,
      complete: img.complete
    });
  });
}

// Ex√©cuter apr√®s le chargement des images
window.addEventListener('load', () => {
  setTimeout(debugImages, 1000);
});

// Notifications
if(Notification.permission !== "granted") Notification.requestPermission();
</script>

<script>
function shareSite() {
  const siteURL = "https://izrussia-production.up.railway.app";
  if (navigator.share) {
    navigator.share({
      title: "Izrussia",
      text: "D√©couvre Izrussia ‚Äî achats s√©curis√©s et garantis !",
      url: siteURL
    });
  } else {
    alert("Partagez ce lien avec vos amis : " + siteURL);
  }
}
</script>

</body>
</html>